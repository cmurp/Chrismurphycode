<html>
<head>
    <% include ./partials/head %>
    <script>
    $( document ).ready(function() {
        <% for(tag in post.tags){ %>
            $.ajax({
                type: 'POST',
                data: {tag : '<%= tag %>'},
                url: '/getTag',
                success: function(data) {
                    var newTag = data;
                    $("#<%= post._id %>-tags").append('<label><span class="badge" style="background-color: ' + newTag.color + '">' + newTag.tag + '</span></label>');
                }
            });
        <% } %>
    });
    </script>
    <style>
    h3, h5{
        display: inline;
    }
    </style>
</head>
<body>
    <% include ./partials/sidebar %>
    <div class="container-fluid p-0">
          <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="/projects">Projects</a></li>
            <li class="breadcrumb-item"><a href="/projects/<%= project %>"><%= project %></a></li>
            <li class="breadcrumb-item active" aria-current="page"><%= post.title %></li>
          </ol>
          <div class="container">
              <h1>Edit Post</h1>
              <form method="post" action="/editPost">
                  <input id="id" name="id" type="hidden" value="<%= post._id %>">

                  <div class="form-group">
                    <label for="title">Post Title</label>
                    <input class="form-control form-control-sm" id="title" name="title" type="text" value="<%= post.title %>">
                  </div>

                  <div class="form-group">
                    <label for="github">Commit Link</label>
                    <input class="form-control form-control-sm" id="github" name="github" type="text" value="<%= post.github %>">
                  </div>

                  <h5>Tags</h5>
                  <div class="form-group tags">
                    <% for(let i = 0; i < tags.length; i++) { %>
                        <div class="form-check" id="<%= tags[i]._id %>">
                          <input type="checkbox" class="form-check-input" id="featured" name=tags[<%= tags[i].tag %>] <% if (tags[i].tag in post.tags) { %>  checked <% } %>>
                          <label><span class="badge" style="background-color: <%= tags[i].color %>"><%= tags[i].tag %></span>&nbsp;
                              <button type="button" class="close removeTagButton" aria-label="Close" value="<%= tags[i]._id %>">
                                  <span aria-hidden="true">&times;</span>
                              </button>
                          </label>
                        </div>
                    <% } %>
                    </div>

                  <div class="form-check">
                      <label>
                          <input class="form-control form-control-sm" id="tag" type="text">
                          <input type="color" id="tagColor" name="color" value="#e66465" />
                          <div class="btn btn-success btn-sm" id="tagButton">Add tag</div>
                      </label>
                  </div>
                  <script type="text/javascript">
                          $(function(){
                              $('#tagButton').click(function(e){
                                  e.preventDefault();
                                  var data = {};
                                  data.tag = document.getElementById("tag").value;
                                  data.color = document.getElementById("tagColor").value;

                                  $.ajax({
                                      type: 'POST',
                                      data: JSON.stringify(data),
                                      contentType: 'application/json',
                                      url: 'http://localhost:8080/addTag',
                                      success: function(data) {
                                          console.log('success');
                                          var newTag = data;
                                          $(".tags").append("<div class='form-check'><input type='checkbox' class='form-check-input' id='featured' name=tags[" + newTag.tag + "] >" +
                                            "<label><span class='badge' style='background-color:" + newTag.color + ";'>" + newTag.tag + "</span>&nbsp;<button type='button' class='close removeTagButton' aria-label='Close'" +
                                            "value='" + newTag.tag + "'><span aria-hidden='true'>&times;</span></button></label></div>");
                                      }
                                  });
                              });
                          });
                          $(function(){
                              $('.removeTagButton').click(function(e){
                                  e.preventDefault();
                                  var data = {};
                                  data.tag = $(this).val();;

                                  $.ajax({
                                      type: 'POST',
                                      data: JSON.stringify(data),
                                      contentType: 'application/json',
                                      url: 'http://localhost:8080/removeTag',
                                      success: function() {
                                          console.log('success');
                                          $(".tags").children("#"+data.tag).remove();
                                      }
                                  });
                              });
                          });
                  </script>

                  <div class="form-check">
                      <select class="mdb-select md-form" name="project">
                        <option name="project" value="<%= project %>"><%= project %></option>
                      </select>
                      <label>Associated Project</label>
                  </div>

                <div class="form-group">
                  <label for="content">Post Details</label>
                  <textarea class="form-control" name="content" rows="15"><%= post.content %></textarea>
                </div>
                <input type="submit" class="btn btn-primary">
              </form>
          </div>
  </div>
  <% include ./partials/scripts %>
</body>
</html>
